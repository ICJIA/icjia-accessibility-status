version: "3.8"

services:
  # Backend API Service
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: icjia-accessibility-backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
      - VITE_DOCS_URL=${VITE_DOCS_URL:-http://localhost:3002}
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:3001/api/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - icjia-network
    volumes:
      - ./server:/app/server
      - ./src:/app/src
    # Note: Supabase is cloud-hosted, not containerized
    # Backend will connect to Supabase via VITE_SUPABASE_URL environment variable

  # Frontend Service
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: icjia-accessibility-frontend
    ports:
      - "5173:80"
    environment:
      - VITE_SUPABASE_URL=${VITE_SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY}
      - VITE_API_URL=${VITE_API_URL:-http://localhost:3001/api}
      - VITE_DOCS_URL=${VITE_DOCS_URL:-http://localhost:3002}
    restart: unless-stopped
    networks:
      - icjia-network
    depends_on:
      - backend
    volumes:
      - ./src:/app/src
      - ./public:/app/public
      - ./nginx.conf:/etc/nginx/nginx.conf:ro

  # Documentation Service (Docusaurus)
  docs:
    build:
      context: .
      dockerfile: Dockerfile.docs
    container_name: icjia-accessibility-docs
    ports:
      - "3002:3002"
    restart: unless-stopped
    networks:
      - icjia-network
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:3002/",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Nginx Reverse Proxy (optional - for production-like setup)
  nginx:
    image: nginx:alpine
    container_name: icjia-accessibility-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    restart: unless-stopped
    networks:
      - icjia-network
    depends_on:
      - backend
      - frontend
      - docs

networks:
  icjia-network:
    driver: bridge
# Usage:
# 1. Copy .env.sample to .env and fill in your Supabase credentials
# 2. Run: docker-compose up -d
# 3. Frontend: http://localhost:5173
# 4. Backend: http://localhost:3001
# 5. Documentation: http://localhost:3002
# 6. Nginx (production-like): http://localhost:80
# 7. View logs: docker-compose logs -f backend
# 8. View all services: docker-compose ps
# 9. Stop: docker-compose down
#
# IMPORTANT NOTES:
# - Supabase is cloud-hosted, not containerized
# - Ensure .env file has valid VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY
# - First build may take 2-3 minutes
# - Health checks will verify all services are running

